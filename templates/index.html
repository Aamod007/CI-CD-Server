<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CI/CD Pipeline - DevOps Platform</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: #f8fafc; color: #1e293b; min-height: 100vh; }
        .hidden { display: none !important; }
        
        /* Auth Page */
        .auth-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 24px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); }
        .auth-card { background: white; border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.08); width: 100%; max-width: 420px; padding: 48px; }
        
        .logo { display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 32px; }
        .logo-icon { width: 48px; height: 48px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); border-radius: 14px; display: flex; align-items: center; justify-content: center; }
        .logo-icon i { font-size: 22px; color: white; }
        .logo-text { font-size: 22px; font-weight: 700; color: #1e293b; }
        
        .auth-header { text-align: center; margin-bottom: 32px; }
        .auth-header h1 { font-size: 26px; color: #1e293b; margin-bottom: 8px; font-weight: 700; }
        .auth-header p { color: #64748b; font-size: 15px; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; color: #475569; font-size: 14px; margin-bottom: 8px; font-weight: 500; }
        .form-group input { width: 100%; padding: 14px 16px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; color: #1e293b; font-size: 15px; transition: all 0.2s; }
        .form-group input:focus { outline: none; border-color: #3b82f6; background: white; box-shadow: 0 0 0 4px rgba(59,130,246,0.1); }
        .form-group input::placeholder { color: #94a3b8; }
        
        .btn { padding: 14px 24px; border: none; border-radius: 12px; cursor: pointer; font-family: inherit; font-size: 15px; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-primary { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(59,130,246,0.35); }
        .btn-secondary { background: #f1f5f9; color: #475569; border: 2px solid #e2e8f0; }
        .btn-secondary:hover { background: #e2e8f0; border-color: #cbd5e1; }
        .btn-github { background: #24292e; color: white; }
        .btn-github:hover { background: #1a1e22; transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        .btn-full { width: 100%; }
        .btn-sm { padding: 10px 16px; font-size: 13px; }
        .btn-danger { background: #fee2e2; color: #dc2626; }
        .btn-danger:hover { background: #fecaca; }
        .btn-success { background: #dcfce7; color: #16a34a; }
</style>
</head>
<body>
    <!-- Auth Section -->
    <div id="auth-section" class="auth-container">
        <div class="auth-card">
            <div class="logo">
                <div class="logo-icon"><i class="fas fa-rocket"></i></div>
                <span class="logo-text">Pipeline</span>
            </div>
            <div class="auth-header">
                <h1 id="auth-title">Welcome back</h1>
                <p id="auth-subtitle">Sign in to continue to your dashboard</p>
            </div>
            <div id="alert-auth"></div>
            
            <button class="btn btn-github btn-full" onclick="loginWithGithub()" style="margin-bottom: 24px;">
                <i class="fab fa-github"></i> Continue with GitHub
            </button>
            
            <div class="divider"><span>or</span></div>
            
            <form id="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="login-email" required placeholder="you@example.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="login-password" required placeholder="••••••••">
                </div>
                <button type="submit" class="btn btn-primary btn-full">Sign In</button>
            </form>
            
            <form id="register-form" class="hidden" onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="register-email" required placeholder="you@example.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="register-password" required placeholder="••••••••">
                </div>
                <button type="submit" class="btn btn-primary btn-full">Create Account</button>
            </form>
            
            <p class="auth-switch">
                <span id="switch-text">Don't have an account?</span>
                <a href="#" onclick="toggleAuthMode(event)" id="switch-link">Sign up</a>
            </p>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden">
        <nav class="navbar">
            <div class="nav-left">
                <div class="logo" style="margin-bottom: 0;">
                    <div class="logo-icon"><i class="fas fa-rocket"></i></div>
                    <span class="logo-text">Pipeline</span>
                </div>
            </div>
            <div class="nav-right">
                <a href="#" onclick="openDashboard()" class="nav-link"><i class="fas fa-chart-line"></i> Analytics</a>
                <div class="user-info">
                    <div class="user-avatar"><i class="fas fa-user"></i></div>
                    <span id="user-email"></span>
                    <button class="btn btn-secondary btn-sm" onclick="logout()">Sign Out</button>
                </div>
            </div>
        </nav>
        
        <div class="main-content">
            <!-- Quick Actions -->
            <div class="quick-actions">
                <div class="action-card" onclick="showNewPipelineModal()">
                    <div class="action-icon" style="background: linear-gradient(135deg, #3b82f6, #2563eb);"><i class="fas fa-plus"></i></div>
                    <div class="action-text">
                        <h4>New Pipeline</h4>
                        <p>Run a new CI/CD job</p>
                    </div>
                </div>
                <div class="action-card" onclick="openDashboard()">
                    <div class="action-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);"><i class="fas fa-chart-bar"></i></div>
                    <div class="action-text">
                        <h4>Analytics</h4>
                        <p>View pipeline metrics</p>
                    </div>
                </div>
                <div class="action-card" onclick="loadJobs()">
                    <div class="action-icon" style="background: linear-gradient(135deg, #10b981, #059669);"><i class="fas fa-sync"></i></div>
                    <div class="action-text">
                        <h4>Refresh</h4>
                        <p>Update job status</p>
                    </div>
                </div>
            </div>
            
            <!-- Jobs Section -->
            <div class="section-card">
                <div class="section-header">
                    <h2><i class="fas fa-layer-group"></i> Recent Pipelines</h2>
                    <span class="badge" id="jobs-count">0 jobs</span>
                </div>
                <div id="jobs-container"></div>
            </div>
        </div>
    </div>

    <!-- New Pipeline Modal -->
    <div id="pipeline-modal" class="modal hidden">
        <div class="modal-overlay" onclick="closePipelineModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-rocket"></i> New Pipeline</h3>
                <button class="btn-close" onclick="closePipelineModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Repository URL</label>
                    <input type="text" id="repo-url" placeholder="https://github.com/username/repo">
                </div>
                <div class="form-group">
                    <label>Branch</label>
                    <input type="text" id="branch" value="main" placeholder="main">
                </div>
                <div class="form-group">
                    <label>Build Commands (optional)</label>
                    <textarea id="build-commands" class="form-textarea" placeholder="pip install -r requirements.txt&#10;python main.py"></textarea>
                    <small class="form-hint">Leave empty to auto-detect project type</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePipelineModal()">Cancel</button>
                <button class="btn btn-primary" onclick="runPipeline()"><i class="fas fa-play"></i> Run Pipeline</button>
            </div>
        </div>
    </div>
    
    <!-- Logs Modal -->
    <div id="logs-modal" class="modal hidden">
        <div class="modal-overlay" onclick="closeLogsModal()"></div>
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h3><i class="fas fa-terminal"></i> Pipeline Logs</h3>
                <button class="btn-close" onclick="closeLogsModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body logs-body" id="logs-container"></div>
        </div>
    </div>

    <style>
        .divider { display: flex; align-items: center; margin: 24px 0; color: #94a3b8; font-size: 13px; }
        .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: #e2e8f0; }
        .divider span { padding: 0 16px; }
        
        .auth-switch { text-align: center; margin-top: 24px; color: #64748b; font-size: 14px; }
        .auth-switch a { color: #3b82f6; text-decoration: none; font-weight: 600; margin-left: 4px; }
        .auth-switch a:hover { text-decoration: underline; }
        
        .alert { padding: 14px 16px; border-radius: 12px; margin-bottom: 20px; font-size: 14px; }
        .alert-error { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
        .alert-success { background: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0; }
        
        /* Navbar */
        .navbar { display: flex; justify-content: space-between; align-items: center; padding: 16px 32px; background: white; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 100; }
        .nav-right { display: flex; align-items: center; gap: 24px; }
        .nav-link { color: #64748b; text-decoration: none; font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 8px; padding: 8px 16px; border-radius: 8px; transition: all 0.2s; }
        .nav-link:hover { color: #3b82f6; background: #f0f9ff; }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-avatar { width: 36px; height: 36px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; }
        .user-info span { color: #64748b; font-size: 14px; }
        
        /* Main Content */
        .main-content { max-width: 1000px; margin: 0 auto; padding: 32px; }
        
        /* Quick Actions */
        .quick-actions { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 32px; }
        .action-card { background: white; border: 1px solid #e2e8f0; border-radius: 16px; padding: 24px; display: flex; align-items: center; gap: 16px; cursor: pointer; transition: all 0.2s; }
        .action-card:hover { border-color: #3b82f6; box-shadow: 0 8px 24px rgba(59,130,246,0.12); transform: translateY(-2px); }
        .action-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; }
        .action-text h4 { color: #1e293b; font-size: 15px; margin-bottom: 4px; }
        .action-text p { color: #94a3b8; font-size: 13px; }
        
        /* Section Card */
        .section-card { background: white; border: 1px solid #e2e8f0; border-radius: 20px; overflow: hidden; }
        .section-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid #f1f5f9; }
        .section-header h2 { font-size: 16px; color: #1e293b; display: flex; align-items: center; gap: 10px; font-weight: 600; }
        .section-header h2 i { color: #3b82f6; }
        .badge { background: #f1f5f9; color: #64748b; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; }
        
        /* Jobs List */
        .job-item { display: flex; align-items: center; padding: 20px 24px; border-bottom: 1px solid #f1f5f9; transition: background 0.2s; }
        .job-item:last-child { border-bottom: none; }
        .job-item:hover { background: #fafbfc; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 16px; flex-shrink: 0; }
        .status-pending { background: #94a3b8; }
        .status-running { background: #3b82f6; animation: pulse 1.5s infinite; }
        .status-success { background: #22c55e; }
        .status-failed { background: #ef4444; }
        .status-cancelled { background: #f59e0b; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .job-info { flex: 1; min-width: 0; }
        .job-name { color: #1e293b; font-weight: 600; font-size: 14px; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .job-meta { color: #94a3b8; font-size: 13px; }
        .job-status { padding: 6px 14px; border-radius: 8px; font-size: 12px; font-weight: 600; margin-right: 16px; text-transform: capitalize; }
        .job-status.pending { background: #f1f5f9; color: #64748b; }
        .job-status.running { background: #dbeafe; color: #2563eb; }
        .job-status.success { background: #dcfce7; color: #16a34a; }
        .job-status.failed { background: #fee2e2; color: #dc2626; }
        .job-status.cancelled { background: #fef3c7; color: #d97706; }
        .job-actions { display: flex; gap: 8px; }
        
        /* Empty State */
        .empty-state { text-align: center; padding: 60px 24px; }
        .empty-state i { font-size: 48px; color: #cbd5e1; margin-bottom: 16px; }
        .empty-state h3 { color: #64748b; font-size: 16px; margin-bottom: 8px; }
        .empty-state p { color: #94a3b8; font-size: 14px; }
        
        /* Modal */
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15,23,42,0.5); backdrop-filter: blur(4px); }
        .modal-content { position: relative; background: white; border-radius: 20px; width: 90%; max-width: 500px; max-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 25px 60px rgba(0,0,0,0.2); }
        .modal-lg { max-width: 700px; }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { color: #1e293b; font-size: 18px; display: flex; align-items: center; gap: 10px; font-weight: 600; }
        .modal-header h3 i { color: #3b82f6; }
        .modal-body { padding: 24px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid #f1f5f9; display: flex; justify-content: flex-end; gap: 12px; }
        .btn-close { background: none; border: none; color: #94a3b8; font-size: 18px; cursor: pointer; padding: 8px; border-radius: 8px; transition: all 0.2s; }
        .btn-close:hover { background: #f1f5f9; color: #64748b; }
        
        /* Form Elements */
        .form-textarea { width: 100%; padding: 14px 16px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; color: #1e293b; font-family: 'SF Mono', 'Fira Code', monospace; font-size: 13px; min-height: 100px; resize: vertical; }
        .form-textarea:focus { outline: none; border-color: #3b82f6; background: white; }
        .form-hint { color: #94a3b8; font-size: 12px; margin-top: 6px; display: block; }
        
        /* Logs */
        .logs-body { background: #0f172a; border-radius: 12px; font-family: 'SF Mono', 'Fira Code', monospace; font-size: 13px; padding: 20px; max-height: 400px; overflow-y: auto; }
        .log-line { padding: 4px 0; color: #94a3b8; line-height: 1.6; }
        .log-line.info { color: #94a3b8; }
        .log-line.warn { color: #fbbf24; }
        .log-line.error { color: #f87171; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .navbar { padding: 12px 16px; }
            .main-content { padding: 16px; }
            .quick-actions { grid-template-columns: 1fr; }
            .user-info span { display: none; }
            .job-actions { flex-wrap: wrap; }
        }
    </style>

    <script>
        const API = '/api';
        let token = localStorage.getItem('token');
        let githubToken = localStorage.getItem('github_token');
        let supabaseToken = localStorage.getItem('supabase_token');
        let logsInterval = null;
        let isLoginMode = true;

        if (supabaseToken && !token) {
            handleGithubLogin(supabaseToken);
        } else if (token) {
            checkAuth();
        }

        async function handleGithubLogin(ghToken) {
            token = ghToken;
            localStorage.setItem('token', token);
            githubToken = ghToken;
            checkAuth();
        }

        async function api(endpoint, options = {}) {
            const headers = { 'Content-Type': 'application/json' };
            if (token) headers['Authorization'] = `Bearer ${token}`;
            const res = await fetch(`${API}${endpoint}`, { ...options, headers });
            return res.json();
        }

        function showAlert(containerId, message, type) {
            document.getElementById(containerId).innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => document.getElementById(containerId).innerHTML = '', 4000);
        }

        function toggleAuthMode(e) {
            e.preventDefault();
            isLoginMode = !isLoginMode;
            document.getElementById('login-form').classList.toggle('hidden', !isLoginMode);
            document.getElementById('register-form').classList.toggle('hidden', isLoginMode);
            document.getElementById('auth-title').textContent = isLoginMode ? 'Welcome back' : 'Create account';
            document.getElementById('auth-subtitle').textContent = isLoginMode ? 'Sign in to continue to your dashboard' : 'Get started with your free account';
            document.getElementById('switch-text').textContent = isLoginMode ? "Don't have an account?" : 'Already have an account?';
            document.getElementById('switch-link').textContent = isLoginMode ? 'Sign up' : 'Sign in';
        }

        async function handleLogin(e) {
            e.preventDefault();
            const data = await api('/auth/login', {
                method: 'POST',
                body: JSON.stringify({ email: document.getElementById('login-email').value, password: document.getElementById('login-password').value })
            });
            if (data.token) { token = data.token; localStorage.setItem('token', token); checkAuth(); }
            else showAlert('alert-auth', data.error || 'Login failed', 'error');
        }

        async function handleRegister(e) {
            e.preventDefault();
            const data = await api('/auth/register', {
                method: 'POST',
                body: JSON.stringify({ email: document.getElementById('register-email').value, password: document.getElementById('register-password').value })
            });
            if (data.token) { token = data.token; localStorage.setItem('token', token); checkAuth(); }
            else showAlert('alert-auth', data.error || 'Registration failed', 'error');
        }

        async function checkAuth() {
            const data = await api('/auth/me');
            if (data.email) {
                document.getElementById('user-email').textContent = data.email;
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                loadJobs();
            } else logout();
        }

        function logout() {
            token = null; githubToken = null;
            localStorage.removeItem('token');
            localStorage.removeItem('github_token');
            localStorage.removeItem('supabase_token');
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
        }

        function loginWithGithub() {
            const supabaseUrl = 'https://qbphsmgryrezirqrcwdz.supabase.co';
            const redirectTo = encodeURIComponent(window.location.origin + '/auth/callback');
            const scopes = 'repo,user:email';
            window.location.href = `${supabaseUrl}/auth/v1/authorize?provider=github&redirect_to=${redirectTo}&scopes=${scopes}`;
        }

        function showNewPipelineModal() {
            document.getElementById('pipeline-modal').classList.remove('hidden');
        }

        function closePipelineModal() {
            document.getElementById('pipeline-modal').classList.add('hidden');
        }

        async function runPipeline() {
            const repoUrl = document.getElementById('repo-url').value.trim();
            const branch = document.getElementById('branch').value.trim() || 'main';
            
            if (!repoUrl) { alert('Please enter a repository URL'); return; }
            
            const data = await api('/jobs', {
                method: 'POST',
                body: JSON.stringify({ repo_url: repoUrl, branch })
            });
            
            if (data.id) {
                closePipelineModal();
                document.getElementById('repo-url').value = '';
                loadJobs();
            } else {
                alert(data.error || 'Failed to create pipeline');
            }
        }

        async function loadJobs() {
            const jobs = await api('/jobs');
            const container = document.getElementById('jobs-container');
            document.getElementById('jobs-count').textContent = `${jobs?.length || 0} jobs`;
            
            if (!jobs || !jobs.length) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3>No pipelines yet</h3>
                        <p>Click "New Pipeline" to run your first CI/CD job</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = jobs.map(job => `
                <div class="job-item">
                    <div class="status-dot status-${job.status}"></div>
                    <div class="job-info">
                        <div class="job-name">${job.repo_url ? job.repo_url.split('/').pop().replace('.git', '') : 'Unknown'}</div>
                        <div class="job-meta">${job.branch || 'main'} • ${formatTime(job.created_at)}</div>
                    </div>
                    <span class="job-status ${job.status}">${job.status}</span>
                    <div class="job-actions">
                        <button class="btn btn-secondary btn-sm" onclick="viewLogs('${job.id}')"><i class="fas fa-terminal"></i></button>
                        ${job.status === 'running' ? `<button class="btn btn-danger btn-sm" onclick="cancelJob('${job.id}')"><i class="fas fa-stop"></i></button>` : ''}
                        ${['failed','cancelled'].includes(job.status) ? `<button class="btn btn-success btn-sm" onclick="retryJob('${job.id}')"><i class="fas fa-redo"></i></button>` : ''}
                        <button class="btn btn-secondary btn-sm" onclick="deleteJob('${job.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function formatTime(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diff = (now - date) / 1000;
            if (diff < 60) return 'Just now';
            if (diff < 3600) return `${Math.floor(diff/60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff/3600)}h ago`;
            return date.toLocaleDateString();
        }

        async function viewLogs(jobId) {
            document.getElementById('logs-modal').classList.remove('hidden');
            loadLogs(jobId);
            logsInterval = setInterval(() => loadLogs(jobId), 3000);
        }

        async function loadLogs(jobId) {
            const logs = await api(`/jobs/${jobId}/logs`);
            const container = document.getElementById('logs-container');
            if (!logs || !logs.length) {
                container.innerHTML = '<div class="log-line">Waiting for logs...</div>';
                return;
            }
            container.innerHTML = logs.map(log => `<div class="log-line ${log.level}">[${log.level.toUpperCase()}] ${log.message}</div>`).join('');
            container.scrollTop = container.scrollHeight;
        }

        function closeLogsModal() {
            document.getElementById('logs-modal').classList.add('hidden');
            if (logsInterval) clearInterval(logsInterval);
        }

        async function cancelJob(id) { await api(`/jobs/${id}/cancel`, { method: 'POST' }); loadJobs(); }
        async function retryJob(id) { await api(`/jobs/${id}/retry`, { method: 'POST' }); loadJobs(); }
        async function deleteJob(id) { if (confirm('Delete this pipeline?')) { await api(`/jobs/${id}`, { method: 'DELETE' }); loadJobs(); } }
        
        function openDashboard() {
            if (token) window.open(`/dashboard/?token=${encodeURIComponent(token)}`, '_blank');
        }
    </script>
</body>
</html>
