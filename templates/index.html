<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pipeline Monitor</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: #f8fafc; color: #1e293b; min-height: 100vh; }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        .container { max-width: 800px; margin: 0 auto; padding: 24px; }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 24px;
        }
        .header h1 { font-size: 20px; font-weight: 600; color: #1e293b; }
        .header-sub { color: #64748b; font-size: 13px; margin-left: 12px; }
        
        .live-badge { display: flex; align-items: center; gap: 6px; }
        .live-dot { color: #22c55e; font-size: 10px; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        
        /* Auth */
        #auth-section { max-width: 400px; margin: 60px auto; }
        .auth-tabs { display: flex; gap: 8px; margin-bottom: 24px; }
        .auth-tabs button {
            flex: 1;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            color: #64748b;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .auth-tabs button.active {
            background: #6366f1;
            border-color: #6366f1;
            color: white;
        }
        .auth-tabs button:hover:not(.active) { background: #e2e8f0; }
        
        .form-group { margin-bottom: 16px; }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #475569;
            font-size: 13px;
            font-weight: 500;
        }
        .form-group input {
            width: 100%;
            padding: 12px 16px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            color: #1e293b;
            font-family: inherit;
            font-size: 14px;
            transition: all 0.2s;
        }
        .form-group input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99,102,241,0.1);
        }
        .form-group input::placeholder { color: #94a3b8; }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-primary { background: #6366f1; color: white; width: 100%; }
        .btn-primary:hover { background: #4f46e5; }
        .btn-secondary { background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }
        .btn-secondary:hover { background: #e2e8f0; }
        .btn-danger { background: #fef2f2; color: #ef4444; border: 1px solid #fecaca; }
        .btn-danger:hover { background: #fee2e2; }
        .btn-small { padding: 8px 14px; font-size: 13px; }
        
        /* Dashboard */
        #dashboard { display: none; }
        #dashboard.visible { display: block; }
        .hidden { display: none; }
        
        .user-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 24px;
        }
        .user-email { color: #64748b; font-size: 14px; }
        
        .dashboard-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #6366f1;
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            padding: 8px 16px;
            background: #eef2ff;
            border-radius: 8px;
            transition: all 0.2s;
        }
        .dashboard-link:hover { background: #e0e7ff; }
        
        /* Create Job */
        .section-title { font-size: 14px; font-weight: 600; color: #1e293b; margin-bottom: 16px; }
        .create-job-form { display: flex; gap: 12px; }
        .create-job-form input {
            flex: 1;
            padding: 12px 16px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            color: #1e293b;
            font-family: inherit;
            font-size: 14px;
        }
        .create-job-form input:focus { outline: none; border-color: #6366f1; }
        .create-job-form input::placeholder { color: #94a3b8; }
        
        /* Jobs */
        .jobs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .job-item {
            display: flex;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        .job-item:last-child { border-bottom: none; }
        
        .status-dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 14px; }
        .status-pending { background: #94a3b8; }
        .status-running { background: #3b82f6; animation: pulse 1s infinite; }
        .status-success { background: #22c55e; }
        .status-failed { background: #ef4444; }
        .status-cancelled { background: #f59e0b; }
        
        .job-info { flex: 1; }
        .job-repo { font-weight: 500; font-size: 14px; color: #1e293b; }
        .job-meta { color: #64748b; font-size: 12px; margin-top: 4px; }
        
        .job-status {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            margin-right: 16px;
        }
        .job-status.pending { background: #f1f5f9; color: #64748b; }
        .job-status.running { background: #eff6ff; color: #3b82f6; }
        .job-status.success { background: #f0fdf4; color: #22c55e; }
        .job-status.failed { background: #fef2f2; color: #ef4444; }
        .job-status.cancelled { background: #fffbeb; color: #f59e0b; }
        
        .job-actions { display: flex; gap: 8px; }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .modal.hidden { display: none; }
        .modal-content {
            background: #ffffff;
            border-radius: 16px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
        }
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 { font-size: 16px; font-weight: 600; }
        .modal-body { padding: 24px; overflow-y: auto; flex: 1; background: #f8fafc; }
        
        .log-entry {
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 12px;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 4px;
            background: #ffffff;
            border: 1px solid #e2e8f0;
        }
        .log-info { color: #64748b; }
        .log-warn { color: #f59e0b; background: #fffbeb; border-color: #fef3c7; }
        .log-error { color: #ef4444; background: #fef2f2; border-color: #fecaca; }
        
        .empty-state { text-align: center; padding: 60px 20px; color: #64748b; }
        
        .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; }
        .alert-error { background: #fef2f2; color: #ef4444; border: 1px solid #fecaca; }
        .alert-success { background: #f0fdf4; color: #22c55e; border: 1px solid #bbf7d0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; align-items: center;">
                <h1>Pipeline Monitor</h1>
                <span class="header-sub">CI/CD Automation</span>
            </div>
            <div class="live-badge">
                <span class="live-dot">‚óè</span>
                <span style="font-size: 13px; color: #64748b;">Live</span>
            </div>
        </div>
        
        <!-- Auth Section -->
        <div id="auth-section">
            <div class="card">
                <div class="auth-tabs">
                    <button class="active" onclick="showTab('login')">Sign In</button>
                    <button onclick="showTab('register')">Create Account</button>
                </div>
                <div id="alert-auth"></div>
                <form id="login-form" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="login-email" required placeholder="you@example.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="login-password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button type="submit" class="btn btn-primary">Sign In</button>
                </form>
                <form id="register-form" class="hidden" onsubmit="handleRegister(event)">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="register-email" required placeholder="you@example.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="register-password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button type="submit" class="btn btn-primary">Create Account</button>
                </form>
            </div>
        </div>
        
        <!-- Dashboard -->
        <div id="dashboard">
            <div class="user-bar">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <span class="user-email" id="user-email"></span>
                    <a href="/dashboard/" target="_blank" class="dashboard-link">üìä Analytics</a>
                </div>
                <button class="btn btn-secondary btn-small" onclick="logout()">Sign Out</button>
            </div>
            
            <div class="card">
                <div class="section-title">New Pipeline</div>
                <form class="create-job-form" onsubmit="createJob(event)">
                    <input type="text" id="repo-url" placeholder="https://github.com/user/repo" required>
                    <input type="text" id="branch" placeholder="main" value="main" style="max-width: 100px;">
                    <button type="submit" class="btn btn-primary" style="width: auto; padding: 12px 20px;">Run</button>
                </form>
            </div>
            
            <div class="card">
                <div class="jobs-header">
                    <div class="section-title" style="margin: 0;">Recent Pipelines</div>
                    <button class="btn btn-secondary btn-small" onclick="loadJobs()">Refresh</button>
                </div>
                <div id="jobs-container">
                    <div class="empty-state">No pipelines yet. Create one above!</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Logs Modal -->
    <div id="logs-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Pipeline Logs</h3>
                <button class="btn btn-secondary btn-small" onclick="closeLogsModal()">Close</button>
            </div>
            <div class="modal-body" id="logs-container"></div>
        </div>
    </div>

    <script>
        const API = '/api';
        let token = localStorage.getItem('token');
        let logsInterval = null;

        if (token) checkAuth();

        async function api(endpoint, options = {}) {
            const headers = { 'Content-Type': 'application/json' };
            if (token) headers['Authorization'] = `Bearer ${token}`;
            const res = await fetch(`${API}${endpoint}`, { ...options, headers });
            return res.json();
        }

        function showTab(tab) {
            document.querySelectorAll('.auth-tabs button').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('login-form').classList.toggle('hidden', tab !== 'login');
            document.getElementById('register-form').classList.toggle('hidden', tab !== 'register');
        }

        function showAlert(containerId, message, type) {
            document.getElementById(containerId).innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => document.getElementById(containerId).innerHTML = '', 3000);
        }

        async function handleLogin(e) {
            e.preventDefault();
            const data = await api('/auth/login', {
                method: 'POST',
                body: JSON.stringify({ email: document.getElementById('login-email').value, password: document.getElementById('login-password').value })
            });
            if (data.token) { token = data.token; localStorage.setItem('token', token); checkAuth(); }
            else showAlert('alert-auth', data.error || 'Login failed', 'error');
        }

        async function handleRegister(e) {
            e.preventDefault();
            const data = await api('/auth/register', {
                method: 'POST',
                body: JSON.stringify({ email: document.getElementById('register-email').value, password: document.getElementById('register-password').value })
            });
            if (data.token) { token = data.token; localStorage.setItem('token', token); checkAuth(); }
            else showAlert('alert-auth', data.error || 'Registration failed', 'error');
        }

        async function checkAuth() {
            const data = await api('/auth/me');
            if (data.email) {
                document.getElementById('user-email').textContent = data.email;
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('dashboard').classList.add('visible');
                loadJobs();
            } else logout();
        }

        function logout() {
            token = null; localStorage.removeItem('token');
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('dashboard').classList.remove('visible');
        }

        async function loadJobs() {
            const jobs = await api('/jobs');
            const container = document.getElementById('jobs-container');
            if (!jobs.length) { container.innerHTML = '<div class="empty-state">No pipelines yet. Create one above!</div>'; return; }
            container.innerHTML = jobs.map(job => `
                <div class="job-item">
                    <div class="status-dot status-${job.status}"></div>
                    <div class="job-info">
                        <div class="job-repo">${job.repo_url.split('/').pop()}</div>
                        <div class="job-meta">${job.branch} ‚Ä¢ ${new Date(job.created_at).toLocaleTimeString()}</div>
                    </div>
                    <span class="job-status ${job.status}">${job.status}</span>
                    <div class="job-actions">
                        <button class="btn btn-secondary btn-small" onclick="viewLogs('${job.id}')">Logs</button>
                        ${job.status === 'running' ? `<button class="btn btn-danger btn-small" onclick="cancelJob('${job.id}')">Cancel</button>` : ''}
                        ${['failed','cancelled'].includes(job.status) ? `<button class="btn btn-primary btn-small" onclick="retryJob('${job.id}')">Retry</button>` : ''}
                        <button class="btn btn-danger btn-small" onclick="deleteJob('${job.id}')">√ó</button>
                    </div>
                </div>
            `).join('');
        }

        async function createJob(e) {
            e.preventDefault();
            await api('/jobs', { method: 'POST', body: JSON.stringify({ repo_url: document.getElementById('repo-url').value, branch: document.getElementById('branch').value || 'main' }) });
            document.getElementById('repo-url').value = '';
            loadJobs();
        }

        async function viewLogs(jobId) {
            document.getElementById('logs-modal').classList.remove('hidden');
            loadLogs(jobId);
            logsInterval = setInterval(() => loadLogs(jobId), 2000);
        }

        async function loadLogs(jobId) {
            const logs = await api(`/jobs/${jobId}/logs`);
            const container = document.getElementById('logs-container');
            if (!logs.length) { container.innerHTML = '<div class="empty-state">Waiting for logs...</div>'; return; }
            container.innerHTML = logs.map(log => `<div class="log-entry log-${log.level}">[${log.level.toUpperCase()}] ${log.message}</div>`).join('');
            container.scrollTop = container.scrollHeight;
        }

        function closeLogsModal() { document.getElementById('logs-modal').classList.add('hidden'); if (logsInterval) clearInterval(logsInterval); }
        async function cancelJob(id) { await api(`/jobs/${id}/cancel`, { method: 'POST' }); loadJobs(); }
        async function retryJob(id) { await api(`/jobs/${id}/retry`, { method: 'POST' }); loadJobs(); }
        async function deleteJob(id) { if (confirm('Delete?')) { await api(`/jobs/${id}`, { method: 'DELETE' }); loadJobs(); } }
        setInterval(() => { if (token && document.getElementById('dashboard').classList.contains('visible')) loadJobs(); }, 5000);
    </script>
</body>
</html>
